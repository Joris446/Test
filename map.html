<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Direction Challenge</title>
<style>
/* ... your existing CSS stays exactly the same ... */
</style>
</head>
<body>
  <h1 id="arrow-title">Walk into the direction of the arrow</h1>
  <button id="enable-compass">Enable Compass</button>
  <div id="arrow-container">
    <svg id="arrow" viewBox="0 0 120 120">
      <polygon id="arrow-shape" points="60,15 100,100 60,75 20,100" />
    </svg>
  </div>
  <div id="status-text">Waiting for compass...</div>

  <div class="info-row">
    <div id="crowd-container">
      <div id="crowd-square"><div id="crowd-blobs"></div></div>
      <div id="crowd-caption">heatmap of the crowd</div>
    </div>
    <div id="route-saying"></div>
  </div>

<script>
// ---- Route sayings
const sayings = [
  "We picked this route because it avoids the busiest areas.",
  "This way keeps you out of the densest parts of the crowd.",
  "Get there faster with a route thatâ€™s 30% less crowded.",
  "Move more easily, this route is short and 15% less crowded.",
  "Save time with a path that cuts through 40% less congestion."
];
document.getElementById("route-saying").textContent =
  sayings[Math.floor(Math.random() * sayings.length)];

// ---- Heatmap generator
(function(){
  const c = document.getElementById("crowd-blobs");
  c.innerHTML = "";
  for (let r = 0; r < 9; r++) {
    for (let col = 0; col < 9; col++) {
      const b = document.createElement("div");
      b.className = "crowd-blob";
      const rnd = Math.random();
      if (r < 3) b.style.background = "#ff5252";
      else b.style.background = rnd < .4 ? "#ff5252" : rnd < .8 ? "#ffb74d" : "#66bb6a";
      c.appendChild(b);
    }
  }
})();

// ---- Compass logic ----
const arrow = document.getElementById("arrow");
const enableButton = document.getElementById("enable-compass");

let targetAngles = [], currentTarget = 0;
let currentHeading = null, displayHeading = null;
let smoothAlpha = null;
const tolerance = 7;
let withinTarget = false;

const NGROK_URL = "https://graphological-nontheistically-cindy.ngrok-free.dev"; // only change here

// ---- Get next angle from Flask
async function fetchNextAngle() {
  const resp = await fetch(`${NGROK_URL}/get_angle`);
  const data = await resp.json();
  targetAngles[currentTarget] = data.angle;
}

// Arrow page sends tap to Flask
async function reportTap() {
  await fetch(`${NGROK_URL}/tap`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ tap: true })
  });
}

enableButton.addEventListener("click", async ()=>{
  if(typeof DeviceOrientationEvent!=="undefined" &&
     typeof DeviceOrientationEvent.requestPermission==="function"){
    DeviceOrientationEvent.requestPermission().then(state=>{
      if(state==="granted"){
        startCompass();
        enableButton.style.display="none";
        fetchNextAngle();
      }else alert("Compass access denied");
    });
  }else{
    startCompass();
    enableButton.style.display="none";
    fetchNextAngle();
  }
});

function startCompass(){
  window.addEventListener("deviceorientation",handleOrientation,true);
  requestAnimationFrame(updateArrowSmooth);
  document.body.addEventListener("click", handleTap);
}

function handleOrientation(e){
  let heading;
  if(e.webkitCompassHeading!==undefined){heading=e.webkitCompassHeading;}
  else if(e.alpha!=null){heading=360-e.alpha;}
  else return;
  if(smoothAlpha==null)smoothAlpha=heading;
  smoothAlpha=lerpAngle(smoothAlpha,heading,0.15);
  currentHeading=smoothAlpha;
}

function lerpAngle(a,b,t){
  let diff=((b-a+540)%360)-180;
  return (a+diff*t+360)%360;
}

function updateArrowSmooth(){
  if(currentHeading!=null){
    if(displayHeading==null)displayHeading=currentHeading;
    displayHeading=lerpAngle(displayHeading,currentHeading,0.25);
    const target=targetAngles[currentTarget]||0;
    const rot=target-displayHeading;
    arrow.style.transform=`rotate(${rot}deg)`;

    const diff=Math.abs(((currentHeading-target+540)%360)-180);
    withinTarget = diff <= tolerance;
  }
  requestAnimationFrame(updateArrowSmooth);
}

async function handleTap(){
  if(withinTarget){
    await reportTap();
    currentTarget++;
    if(currentTarget >= 6){
      setTimeout(()=>location.href="ending.html",1000);
    } else {
      fetchNextAngle();
    }
  }
}
</script>
</body>
</html>
