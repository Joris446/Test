<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Direction Challenge</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:linear-gradient(135deg,#dff6ff,#b5d9ff); text-align:center; display:flex; flex-direction:column; align-items:center; }
#arrow-title { font-size:2rem; color:#0044aa; font-weight:700; margin-top:40px; margin-bottom:20px; }
#enable-compass { background:#1976d2; color:#fff; border:none; border-radius:12px; padding:12px 24px; font-size:1.1rem; font-weight:600; cursor:pointer; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,.15); transition:all .2s ease-in-out; }
#enable-compass:hover { background:#0d47a1; }
#arrow-container { width:350px; height:350px; display:flex; justify-content:center; align-items:center; background:linear-gradient(135deg,#e3f2fd 60%,#bbdefb 100%); border-radius:50%; box-shadow:0 2px 18px rgba(0,0,0,0.09); border:1px solid #e0ecff; margin-bottom:32px; overflow:hidden; }
#arrow { width:312px; height:312px; transform-origin:50% 50%; }
#arrow-shape { fill:#1976d2; stroke:#0d47a1; stroke-width:2; }
</style>
</head>
<body>
<h1 id="arrow-title">Walk into the direction of the arrow</h1>
<button id="enable-compass">Enable Compass</button>
<div id="arrow-container">
  <svg id="arrow" viewBox="0 0 120 120">
    <polygon id="arrow-shape" points="60,15 100,100 60,75 20,100" />
  </svg>
</div>

<script>
const NGROK_URL = "https://graphological-nontheistically-cindy.ngrok-free.dev"; // your Ngrok URL here
const arrow = document.getElementById("arrow");
const enableButton = document.getElementById("enable-compass");

let currentHeading = null;
let displayHeading = null;
let smoothAlpha = null;
let currentAngle = null;
let tapCount = 0;
const MAX_TAPS = 6;
const tolerance = 7;
let withinTarget = false;

// ----- Compass
enableButton.addEventListener("click", async () => {
  if (typeof DeviceOrientationEvent !== "undefined" &&
      typeof DeviceOrientationEvent.requestPermission === "function") {
    DeviceOrientationEvent.requestPermission().then(state => {
      if (state === "granted") {
        startCompass();
        enableButton.style.display = "none";
        fetchNextAngle();
      } else alert("Compass access denied");
    });
  } else {
    startCompass();
    enableButton.style.display = "none";
    fetchNextAngle();
  }
});

function startCompass() {
  window.addEventListener("deviceorientation", handleOrientation, true);
  requestAnimationFrame(updateArrowSmooth);
  document.body.addEventListener("click", handleTap);
}

function handleOrientation(e) {
  let heading;
  if (e.webkitCompassHeading !== undefined) heading = e.webkitCompassHeading;
  else if (e.alpha != null) heading = 360 - e.alpha;
  else return;

  if (smoothAlpha == null) smoothAlpha = heading;
  smoothAlpha = lerpAngle(smoothAlpha, heading, 0.15);
  currentHeading = smoothAlpha;
}

function lerpAngle(a, b, t) {
  let diff = ((b - a + 540) % 360) - 180;
  return (a + diff * t + 360) % 360;
}

function updateArrowSmooth() {
  if (currentHeading != null && currentAngle != null) {
    if (displayHeading == null) displayHeading = currentHeading;
    displayHeading = lerpAngle(displayHeading, currentHeading, 0.25);

    const rot = currentAngle - displayHeading;
    arrow.style.transform = `rotate(${rot}deg)`;

    const diff = Math.abs(((currentHeading - currentAngle + 540) % 360) - 180);
    withinTarget = diff <= tolerance;
  }
  requestAnimationFrame(updateArrowSmooth);
}

// ----- Fetch angle from Python
async function fetchNextAngle() {
  try {
    const resp = await fetch(`${'https://graphological-nontheistically-cindy.ngrok-free.dev'}/get_angle`);
    const data = await resp.json();
    currentAngle = data.angle;
    console.log("New angle received:", currentAngle);
  } catch (err) {
    console.error("Error fetching angle:", err);
  }
}

// ----- Send tap to Python
async function handleTap() {
  if (!withinTarget) return;

  try {
    await fetch(`${NGROK_URL}/tap`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ tap: true }) });
    tapCount++;
    console.log("Tap sent. Tap count:", tapCount);

    if (tapCount >= MAX_TAPS) {
      setTimeout(() => window.location.href = "ending.html", 500);
    } else {
      await fetchNextAngle();
    }
  } catch (err) {
    console.error("Error sending tap:", err);
  }
}
</script>
</body>
</html>
