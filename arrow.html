<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Direction Challenge</title>
<style>
  body{
    background:linear-gradient(135deg,#dff6ff,#b5d9ff);
    font-family:Arial,sans-serif;
    text-align:center;
    margin:0;padding:0;
  }
  .container{display:flex;flex-direction:column;align-items:center;margin-top:40px;}
  #arrow-title{font-size:2.2rem;color:#0044aa;font-weight:700;margin-bottom:20px;}
  #enable-compass{
    background:#1976d2;color:#fff;border:none;border-radius:12px;
    padding:12px 24px;font-size:1.1rem;font-weight:600;cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,.15);margin-bottom:20px;
    transition:all .2s ease-in-out;
  }
  #enable-compass:hover{background:#0d47a1;box-shadow:0 6px 12px rgba(0,0,0,.2);}
  #arrow-container{
    width:300px;height:300px;display:flex;justify-content:center;align-items:center;
    background:linear-gradient(135deg,#e3f2fd 60%,#bbdefb 100%);
    border-radius:50%;box-shadow:0 2px 18px rgba(0,0,0,.09);
    border:1px solid #e0ecff;margin-bottom:32px;overflow:hidden;
  }
  #arrow{width:220px;height:220px;transform-origin:50% 50%;}
  #arrow-shape{fill:#1976d2;stroke:#0d47a1;stroke-width:2;}
  #status-text{font-size:1.2rem;color:#1976d2;font-weight:600;margin-bottom:24px;}

  .info-row{display:flex;flex-direction:row;align-items:flex-start;justify-content:center;gap:32px;}
  #crowd-square{
    width:90px;height:90px;background:linear-gradient(135deg,#e3f2fd 60%,#bbdefb 100%);
    border-radius:22px;box-shadow:0 2px 12px rgba(0,0,0,.07);
    border:1px solid #e0ecff;display:flex;align-items:center;justify-content:center;
  }
  #crowd-blobs{
    width:78px;height:78px;display:grid;
    grid-template-columns:repeat(9,1fr);grid-template-rows:repeat(9,1fr);gap:1px;
  }
  .crowd-blob{width:7px;height:7px;border-radius:3px;}
  #route-saying{
    width:340px;min-height:70px;background:linear-gradient(135deg,#e3f2fd 60%,#bbdefb 100%);
    border-radius:22px;box-shadow:0 2px 12px rgba(0,0,0,.07);
    display:flex;align-items:center;justify-content:center;
    font-size:1.15em;color:#1976d2;font-weight:500;
    padding:22px 24px;border:1px solid #e0ecff;
  }
  @media(max-width:900px){
    .info-row{flex-direction:column;gap:24px;}
    #crowd-square,#route-saying{width:90vw;min-width:180px;max-width:340px;}
  }
</style>
</head>
<body>
<div class="container">
  <h1 id="arrow-title">Walk into the direction of the arrow</h1>
  <button id="enable-compass">Enable Compass</button>
  <div id="arrow-container">
    <svg id="arrow" viewBox="0 0 120 120">
      <polygon id="arrow-shape" points="60,15 100,100 60,75 20,100"/>
    </svg>
  </div>
  <div id="status-text">Waiting for compass...</div>

  <div class="info-row">
    <div class="crowd-column">
      <div id="crowd-square"><div id="crowd-blobs"></div></div>
      <div id="heatmap-label" style="color:#1976d2;font-weight:600;margin-top:4px;">Heatmap</div>
    </div>
    <div id="route-saying"></div>
  </div>
</div>

<script>
const sayings=[
 "We picked this route because it avoids the busiest areas.",
 "This way keeps you out of the densest parts of the crowd.",
 "Get there faster with a route that’s 30% less crowded.",
 "Move more easily, this route is short and is 15% less crowded.",
 "Save time with a path that cuts through 40% less congestion."
];
document.getElementById("route-saying").textContent=sayings[Math.floor(Math.random()*sayings.length)];

// --- build heatmap
(function(){
 const c=document.getElementById("crowd-blobs");c.innerHTML="";
 for(let r=0;r<9;r++)for(let col=0;col<9;col++){
   const b=document.createElement("div");b.className="crowd-blob";
   if(r<3)b.style.background="#ff5252";
   else{
     const rnd=Math.random();
     b.style.background=rnd<.4?"#ff5252":rnd<.8?"#ffb74d":"#66bb6a";
   }
   c.appendChild(b);
 }
})();

// ---- compass & arrow logic
const arrow=document.getElementById("arrow");
const statusText=document.getElementById("status-text");
const enableButton=document.getElementById("enable-compass");
let targetAngles=[],currentTarget=0;
let currentHeading=null,displayHeading=null;
const tolerance=7;
let smoothAlpha=null;

function generateTargets(){
 targetAngles=[];
 for(let i=0;i<5;i++)targetAngles.push(Math.floor(Math.random()*360));
 console.log("targets",targetAngles);
}

enableButton.addEventListener("click",()=>{
 if(typeof DeviceOrientationEvent!=="undefined" &&
    typeof DeviceOrientationEvent.requestPermission==="function"){
   DeviceOrientationEvent.requestPermission().then(state=>{
     if(state==="granted"){
       startCompass();enableButton.style.display="none";
       generateTargets();showNext();
     }else alert("Compass access denied");
   });
 }else{
   startCompass();enableButton.style.display="none";
   generateTargets();showNext();
 }
});

function startCompass(){
 window.addEventListener("deviceorientation",handleOrientation,true);
 requestAnimationFrame(updateArrowSmooth);
}

function handleOrientation(e){
 let heading;
 if(e.webkitCompassHeading!==undefined){heading=e.webkitCompassHeading;}
 else if(e.alpha!=null){heading=360-e.alpha;}
 else return;
 if(smoothAlpha==null)smoothAlpha=heading;
 smoothAlpha=lerpAngle(smoothAlpha,heading,0.15); // smoother blend
 currentHeading=smoothAlpha;
}

function lerpAngle(a,b,t){
 let diff=((b-a+540)%360)-180;
 return (a+diff*t+360)%360;
}

// update arrow via rAF for smooth motion
function updateArrowSmooth(){
 if(currentHeading!=null){
   if(displayHeading==null)displayHeading=currentHeading;
   displayHeading=lerpAngle(displayHeading,currentHeading,0.25);
   const target=targetAngles[currentTarget]||0;
   const rot=target-displayHeading;
   arrow.style.transform=`rotate(${rot}deg)`;
   checkTarget();
 }
 requestAnimationFrame(updateArrowSmooth);
}

function checkTarget(){
 if(currentHeading==null)return;
 const target=targetAngles[currentTarget];
 let diff=Math.abs(((currentHeading-target+540)%360)-180);
 if(diff<=tolerance){
   statusText.textContent=`✅ Target ${currentTarget+1} reached!`;
   currentTarget++;
   if(currentTarget<targetAngles.length){
     setTimeout(showNext,1000);
   }else{
     setTimeout(()=>location.href="ending.html",1500);
   }
 }
}

function showNext(){
 statusText.textContent=`Good! Now point to the next direction`;
}

</script>
</body>
</html>
